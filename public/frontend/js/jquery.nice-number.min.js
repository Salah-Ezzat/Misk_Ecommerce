(function($) {
    $.fn.spinner = function() {
        this.each(function() {
            var el = $(this);

            // إضافة العناصر
            el.wrap('<span class="spinner"></span>');     
            el.before('<span class="sub">-</span>');
            el.after('<span class="add">+</span>');

            // تقليل الكمية
            el.parent().on('click', '.sub', function () {
                if (el.val() > parseInt(el.attr('min'))) {
                    el.val(function(i, oldval) { 
                        return --oldval; 
                    });
                    updateTotalPrice(el); // تحديث السعر الإجمالي
                    updateTotalAllProducts(); // تحديث إجمالي كل المنتجات
                }
            });

            // زيادة الكمية
            el.parent().on('click', '.add', function () {
                if (el.val() < parseInt(el.attr('max'))) {
                    el.val(function(i, oldval) { 
                        return ++oldval; 
                    });
                    updateTotalPrice(el); // تحديث السعر الإجمالي
                    updateTotalAllProducts(); // تحديث إجمالي كل المنتجات
                }
            });
        });
    };

// دالة لتحديث السعر الإجمالي بناءً على الكمية
function updateTotalPrice(input) {
    // إزالة الفواصل (,) من السعر قبل تحويله إلى عدد
    var priceText = input.closest('tr').find('.product-price').text().replace(/,/g, '');
    var price = parseFloat(priceText);  // تحويل النص إلى عدد
    var quantity = parseInt(input.val()) || 0; // الكمية المدخلة (إذا كانت صفرًا سيتم اعتبارها صفر)
    var targetId = input.data('target'); // الحصول على id الهدف
    var totalInput = $('#' + targetId); // العنصر الذي سيعرض السعر الإجمالي

    if (totalInput.length > 0) {
        // إذا كانت الكمية صفرًا، يجب أن يكون الإجمالي صفرًا
        var total = (quantity > 0) ? (price * quantity).toFixed(2) : "0.00";
        totalInput.val(total); // تحديث السعر الإجمالي
    }
}



// دالة لحساب إجمالي كل المنتجات في الصفحة الحالية فقط
function updateTotalAllProducts() {
    var total = 0;

    // جمع جميع القيم من inputs الخاصة بالسعر الإجمالي
    $('.total_price').each(function() {
        var value = $(this).val().replace(/,/g, ''); // إزالة الفواصل
        total += parseFloat(value) || 0; // تحويل إلى رقم وإضافته
    });

    // تحديث الإجمالي في الحقل المخصص
    $('#total_all_products').val(total.toFixed(2));
}

// دالة لتخزين قيمة في الكوكيز
function setCookie(name, value, days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + value + expires + "; path=/";
}

// دالة لقراءة الكوكيز
function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
    }
    return null;
}

// عند تحميل الصفحة، نبدأ من الصفر (ما نعرضش الكوكيز)
$(document).ready(function() {
    $('#total_all_products').val('0.00');
});

// عند الانتقال لصفحة جديدة: نجمع الإجمالي الحالي للكوكيز
$(document).on('click', '.pagination a', function(e) {
    e.preventDefault(); // منع التحميل التلقائي

    var currentTotal = parseFloat(getCookie('total_cart')) || 0;
    var pageTotal = parseFloat($('#total_all_products').val()) || 0;
    var newTotal = currentTotal + pageTotal;

    setCookie('total_cart', newTotal, 7); // تحديث الكوكيز

    // الانتقال للصفحة التالية
    window.location.href = $(this).attr('href');
});

// عند الوصول للصفحة الأخيرة (مثلاً عبر زر مخصص أو class .last-page)
$(document).on('click', '.last-page', function() {
    var finalTotal = getCookie('total_cart') || '0.00';
    alert('إجمالي كل المنتجات هو: ' + finalTotal + ' جنيه');

    // حذف الكوكيز بعد العرض
    setCookie('total_cart', '', -1);
});


})(jQuery);

// تفعيل الـ spinner لكل الحقول
$('.number_area').spinner();

